---
- name: Check if mongod is running
  shell: ps -ef | grep mongod | grep -v grep | wc -l
  register: mongod_process
  changed_when: false
  ignore_errors: true


- name: mongodb start
  become: yes
  service: name=mongod state=started
  when: "mongod_process.stdout == '0'"
  ignore_errors: yes


- name: Check if redis is running
  shell: ps -ef | grep redis | grep -v grep | wc -l
  register: redis_process
  changed_when: false
  ignore_errors: true


- name: start redis
  become_user: {{user}}
  shell: nohup src/redis-server &
  args:
    chdir: /home/{{user}}/redis-stable/
  async: 60
  poll: 60
  when: "redis_process.stdout == '0'"

- name: Check if logstash graph events is running
  become_user: {{user}}
  shell: ps -ef | grep logstash | grep logstash-graph-events.conf | grep -v grep | wc -l
  register: logstash_process

- name: Check if logstash for word events is running
  become_user: {{user}}
  shell: ps -ef | grep logstash | grep logstash-word-events.conf | grep -v grep | wc -l
  register: word_events_process


- name: Run logstash
  become_user: {{user}}
  become: yes
  shell: /home/{{user}}/logstash-2.3.3/bin/logstash -f /home/{{user}}/logstash-2.3.3/logstash-graph-events.conf -v &
  async: 60
  poll: 30
  when: "logstash_process.stdout == '0'"


- name: Run logstash for word events
  become_user: {{user}}
  become: yes
  shell: chdir=/home/{{user}}/logstash-2.3.3  bin/logstash -f /home/{{user}}/logstash-2.3.3/logstash-word-events.conf -v &
  async: 60
  poll: 30
  when: "word_events_process.stdout == '0'"

- name: start tomcat
  service: name=tomcat state=started