---
- name: Add Elasticsearch GPG key.
  rpm_key: key=https://packages.elastic.co/GPG-KEY-elasticsearch state=present

- name: Add Elasticsearch repository.
  copy: src=elasticsearch.repo dest=/etc/yum.repos.d/elasticsearch.repo mode=0644

- name: Install Elasticsearch.
  yum: pkg=elasticsearch state=installed

- name: stop
  service: name=elasticsearch state=stopped

- name: copy  
  template: src=elasticsearch.yml dest=/etc/elasticsearch/elasticsearch.yml

- name: Change plugins folder permissions
  file: path=/usr/share/elasticsearch/plugins owner=ec2-user group=ec2-user mode=755 recurse=yes state=directory

- name: Change plugins folder permissions
  file: path=/usr/share/elasticsearch owner=ec2-user group=ec2-user mode=755 recurse=yes state=directory

- stat: path=/usr/share/elasticsearch/plugins/head
  register: check_head


- stat: path=/usr/share/elasticsearch/plugins/analysis-icu
  register: check_icu


- stat: path=/usr/share/elasticsearch/plugins/delete-by-query
  register: check_delete

- stat: path=/usr/share/elasticsearch/plugins/mapper-murmur3
  register: check_mapper

- name: Install plugin elasticsearch-head
  command: /usr/share/elasticsearch/bin/plugin install mobz/elasticsearch-head
   #elasticsearch_plugin: state=present name="mobz/elasticsearch-head"
  when: check_head.stat.exists == False

- name:  Install plugin  analysis-icu
  command: /usr/share/elasticsearch/bin/plugin install analysis-icu
  #elasticsearch_plugin: state=present name="analysis-icu"
  when: check_icu.stat.exists == False

- name:  Install plugin delete-by-query
  command: /usr/share/elasticsearch/bin/plugin install delete-by-query
  #elasticsearch_plugin: state=present name="delete-by-query"
  when: check_delete.stat.exists == False

- name:  Install plugin  mapper-murmur3
  command: /usr/share/elasticsearch/bin/plugin install mapper-murmur3
  #elasticsearch_plugin: state=present name="mapper-murmur3"
  when: check_mapper.stat.exists == False

- name: start
  service: name=elasticsearch state=started
